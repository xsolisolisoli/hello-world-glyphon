//TODO refactor to host event loop.